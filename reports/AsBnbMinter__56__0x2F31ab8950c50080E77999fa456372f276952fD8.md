# AsBnbMinter Contract - BNB Chain

## 1. Identity & Sources

- **Name**: AsBnbMinter
- **Address/Chain**: `0x2F31ab8950c50080E77999fa456372f276952fD8` / Chain ID: 56 (BNB Smart Chain)
- **Proxy**: ERC1967 → Implementation: `0x7f52773065fd350b5a935ce2b293fdb16551a6fc`
- **Source files**: `src/AsBnbMinter.sol`
- **Compiler/Settings**: Solidity v0.8.28, Optimizer: Yes (200 runs)

## 2. Authority Map

### 角色权限
- **DEFAULT_ADMIN_ROLE**: 管理其他角色
- **MANAGER**: 管理合约配置
  - 设置费率、最小铸造量、提款费率
  - 启用/禁用存取款
- **PAUSER**: 暂停/恢复合约
- **BOT**: 自动化操作角色
  - 复利奖励
  - 处理铸造队列
- **WITHDRAW_HELPER**: 辅助提款操作

### 关键参数
- **提款费率上限**: 10% (WITHDRAWAL_FEE_RATE_UPPER_BOUND = 1000/10000)
- **费率分母**: 10000 (用于百分比计算)

## 3. Findings

### HIGH-01: 铸造队列可能被操纵
- **严重程度**: High
- **影响**: 高 / 可能性: 中
- **代码位置**: `src/AsBnbMinter.sol#L59-65`
- **技术细节**:
  - 当有活动进行时，铸造请求会被加入队列
  - 队列处理依赖 BOT 角色
  - 如果 BOT 失效或恶意，用户资金可能被锁定
  - 没有超时或自动处理机制
- **攻击场景**:
  1. 用户存入资金，请求被加入队列
  2. BOT 不处理队列
  3. 用户资金被无限期锁定
- **修复建议**:
  - 添加超时机制，允许用户取回资金
  - 实施去中心化的队列处理
  - 添加紧急提款功能
- **状态**: Open

### HIGH-02: 价格计算可能被操纵
- **严重程度**: High
- **影响**: 高 / 可能性: 低
- **代码位置**: `src/AsBnbMinter.sol#L178-193`
```solidity
function convertToTokens(uint256 asBnbAmt) public view returns (uint256) {
    uint256 totalSupply = asBnb.totalSupply();
    return FullMath.mulDiv(asBnbAmt, totalTokens + 1, totalSupply + 1);
}
```
- **技术细节**:
  - 使用 ERC4626 风格的转换公式
  - 添加 +1 防止除零，但可能在极端情况下被利用
  - totalTokens 可以被 BOT 通过复利操作影响
- **修复建议**:
  - 添加价格变化限制
  - 实施预言机价格验证
  - 添加滑点保护
- **状态**: Open

### MEDIUM-01: 提款费用缺少接收地址管理
- **严重程度**: Medium
- **影响**: 中 / 可能性: 低
- **代码位置**: `src/AsBnbMinter.sol#L75-78`
- **技术细节**:
  - withdrawalFeeAvailable 累积但没有明确的提取机制
  - 可能导致费用被锁定在合约中
- **修复建议**: 添加费用提取功能和接收地址管理
- **状态**: Open

### MEDIUM-02: YieldProxy 活动检查可能导致 DoS
- **严重程度**: Medium
- **影响**: 中 / 可能性: 中
- **代码位置**: `src/AsBnbMinter.sol#L342`
```solidity
if (YIELD_PROXY.activitiesOnGoing()) revert AsBnbActivitiesOnGoing();
```
- **技术细节**:
  - 外部合约可以阻止存款操作
  - 如果 YieldProxy 恶意或故障，用户无法存款
- **修复建议**: 添加超时或紧急覆盖机制
- **状态**: Open

### LOW-01: 未验证的外部调用返回值
- **严重程度**: Low
- **影响**: 低 / 可能性: 低
- **代码位置**: 多处外部调用
- **技术细节**: 某些外部调用没有检查返回值
- **修复建议**: 使用 SafeERC20 并检查所有返回值
- **状态**: Open

## 4. 经济模型风险

### 费用机制
1. **复利费用**: 通过 feeRate 收取
2. **提款费用**: 最高 10%，存储在 withdrawalFeeAvailable
3. **风险**: 费用参数可被 MANAGER 任意修改

### 流动性风险
- 依赖底层 SLISBNB 代币的流动性
- 铸造/销毁比率由 totalTokens 和 totalSupply 决定
- 可能受到大额存取款的价格影响

## 5. 链上验证

```bash
# 检查实现合约
cast call 0x2F31ab8950c50080E77999fa456372f276952fD8 \
  "implementation()(address)" \
  --rpc-url https://bsc.drpc.org

# 检查 asBnb 代币地址
cast call 0x7f52773065fd350b5a935ce2b293fdb16551a6fc \
  "asBnb()(address)" \
  --rpc-url https://bsc.drpc.org

# 检查提款费率
cast call 0x7f52773065fd350b5a935ce2b293fdb16551a6fc \
  "withdrawalFeeRate()(uint256)" \
  --rpc-url https://bsc.drpc.org
```